{% extends "base.html" %}

{% block title %}Visualize - acimig v1.0{% endblock %}
{% block page_title %}Fabric Visualization{% endblock %}

{% block content %}

{% if not current_fabric %}
<!-- No Fabric Warning -->
<div class="bg-yellow-50 border-l-4 border-yellow-400 rounded-lg p-6 mb-8">
    <div class="flex items-start">
        <svg class="h-6 w-6 text-yellow-400 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
        </svg>
        <div>
            <h3 class="text-lg font-semibold text-yellow-800 mb-2">No Fabric Selected</h3>
            <p class="text-yellow-700">Please create or select a fabric from the <a href="{{ url_for('index') }}" class="underline hover:text-yellow-900">home page</a> to view visualizations.</p>
        </div>
    </div>
</div>

{% elif not viz_data.get('topology') or not viz_data['topology'].get('nodes') %}
<!-- No Data Warning -->
<div class="bg-blue-50 border-l-4 border-blue-400 rounded-lg p-6 mb-8">
    <div class="flex items-start">
        <svg class="h-6 w-6 text-blue-400 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <div>
            <h3 class="text-lg font-semibold text-blue-800 mb-2">No Data Available</h3>
            <p class="text-blue-700 mb-4">Upload ACI data for fabric "{{ current_fabric }}" to generate visualizations.</p>
            <a href="{{ url_for('analyze') }}" class="inline-flex items-center px-4 py-2 rounded-lg bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700 shadow-lg transition-all duration-200">
                <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                </svg>
                Go to Analysis Page
            </a>
        </div>
    </div>
</div>

{% else %}

<!-- Page Header -->
<div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900 flex items-center">
        <svg class="h-8 w-8 mr-3 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
        </svg>
        Fabric Visualization Dashboard
    </h1>
    <p class="mt-2 text-lg text-gray-600">
        Fabric: <strong class="text-gray-900">{{ current_fabric }}</strong> | Mode: <strong class="text-primary-600">{{ mode|upper }}</strong>
    </p>
</div>

<!-- Tab Navigation -->
<div class="bg-white rounded-xl shadow-sm border border-gray-200 mb-8 overflow-x-auto">
    <div class="flex flex-nowrap min-w-full">
        <button class="dashboard-tab px-6 py-4 text-sm font-medium text-gray-700 hover:text-primary-600 hover:bg-gray-50 border-b-2 border-transparent whitespace-nowrap transition-colors active" data-tab="overview">
            <svg class="h-5 w-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
            </svg>
            Overview
        </button>
        <button class="dashboard-tab px-6 py-4 text-sm font-medium text-gray-700 hover:text-primary-600 hover:bg-gray-50 border-b-2 border-transparent whitespace-nowrap transition-colors" data-tab="topology">
            <svg class="h-5 w-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
            </svg>
            Topology
        </button>
        <button class="dashboard-tab px-6 py-4 text-sm font-medium text-gray-700 hover:text-primary-600 hover:bg-gray-50 border-b-2 border-transparent whitespace-nowrap transition-colors" data-tab="mapping">
            <svg class="h-5 w-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
            </svg>
            Leaf-FEX Mapping
        </button>
        <button class="dashboard-tab px-6 py-4 text-sm font-medium text-gray-700 hover:text-primary-600 hover:bg-gray-50 border-b-2 border-transparent whitespace-nowrap transition-colors" data-tab="hierarchy">
            <svg class="h-5 w-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/>
            </svg>
            Device Hierarchy
        </button>
        <button class="dashboard-tab px-6 py-4 text-sm font-medium text-gray-700 hover:text-primary-600 hover:bg-gray-50 border-b-2 border-transparent whitespace-nowrap transition-colors" data-tab="utilization">
            <svg class="h-5 w-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
            </svg>
            Port Utilization
        </button>
        <button class="dashboard-tab px-6 py-4 text-sm font-medium text-gray-700 hover:text-primary-600 hover:bg-gray-50 border-b-2 border-transparent whitespace-nowrap transition-colors" data-tab="vlans">
            <svg class="h-5 w-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"/>
            </svg>
            VLANs
        </button>
        <button class="dashboard-tab px-6 py-4 text-sm font-medium text-gray-700 hover:text-primary-600 hover:bg-gray-50 border-b-2 border-transparent whitespace-nowrap transition-colors" data-tab="complexity">
            <svg class="h-5 w-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/>
            </svg>
            EPG Complexity
        </button>
        <button class="dashboard-tab px-6 py-4 text-sm font-medium text-gray-700 hover:text-primary-600 hover:bg-gray-50 border-b-2 border-transparent whitespace-nowrap transition-colors" data-tab="migration">
            <svg class="h-5 w-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            Migration Readiness
        </button>
    </div>
</div>

<!-- Overview Dashboard -->
<div id="overview-dashboard" class="dashboard-panel active animate-fade-in">
    <!-- Metrics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600 mb-1">Leaf Switches</p>
                    <p class="text-3xl font-bold text-gray-900">{{ viz_data.get('statistics', {}).get('total_leafs', 0) }}</p>
                </div>
                <div class="h-14 w-14 rounded-xl bg-blue-100 flex items-center justify-center">
                    <svg class="h-8 w-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                    </svg>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600 mb-1">FEX Devices</p>
                    <p class="text-3xl font-bold text-gray-900">{{ viz_data.get('statistics', {}).get('total_fex', 0) }}</p>
                </div>
                <div class="h-14 w-14 rounded-xl bg-green-100 flex items-center justify-center">
                    <svg class="h-8 w-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600 mb-1">Avg Utilization</p>
                    <p class="text-3xl font-bold text-gray-900">{{ viz_data.get('statistics', {}).get('avg_utilization', 0) }}%</p>
                </div>
                <div class="h-14 w-14 rounded-xl bg-purple-100 flex items-center justify-center">
                    <svg class="h-8 w-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600 mb-1">Consolidation Candidates</p>
                    <p class="text-3xl font-bold text-gray-900">{{ viz_data.get('statistics', {}).get('consolidation_candidates', 0) }}</p>
                </div>
                <div class="h-14 w-14 rounded-xl bg-yellow-100 flex items-center justify-center">
                    <svg class="h-8 w-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Utilization Distribution</h3>
            <div class="relative" style="height: 300px;">
                <canvas id="utilizationDistributionChart"></canvas>
            </div>
        </div>
        <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Fabric Health Overview</h3>
            <div class="relative" style="height: 300px;">
                <canvas id="healthOverviewChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Topology Dashboard -->
<div id="topology-dashboard" class="dashboard-panel">
    <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100 mb-8">
        <div class="flex flex-wrap gap-4 items-center mb-4">
            <div class="flex items-center space-x-2">
                <label for="leaf-filter" class="text-sm font-medium text-gray-700">Filter by Leaf:</label>
                <select id="leaf-filter" onchange="filterTopology()" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                    <option value="all">All Leafs</option>
                </select>
            </div>
            <div class="flex items-center space-x-2">
                <button onclick="zoomIn()" class="px-3 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium transition-colors">
                    üîç Zoom In
                </button>
                <button onclick="zoomOut()" class="px-3 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium transition-colors">
                    üîç Zoom Out
                </button>
                <button onclick="resetView()" class="px-3 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium transition-colors">
                    üîÑ Reset
                </button>
            </div>
            <div class="flex items-center space-x-4">
                <label class="flex items-center text-sm text-gray-700">
                    <input type="checkbox" id="show-labels" checked onchange="toggleLabels()" class="mr-2 rounded text-primary-600 focus:ring-primary-500">
                    Show Labels
                </label>
                <label class="flex items-center text-sm text-gray-700">
                    <input type="checkbox" id="highlight-overloaded" onchange="highlightOverloaded()" class="mr-2 rounded text-primary-600 focus:ring-primary-500">
                    Highlight Overloaded (>12 FEX)
                </label>
            </div>
        </div>
        <div class="flex items-center space-x-6 text-sm text-gray-600">
            <div>Leafs Shown: <span id="leafs-shown" class="font-semibold text-gray-900">0</span></div>
            <div>FEX Shown: <span id="fex-shown" class="font-semibold text-gray-900">0</span></div>
            <div>Avg FEX/Leaf: <span id="avg-fex-leaf" class="font-semibold text-gray-900">0</span></div>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100 mb-4">
        <div id="topology-canvas" class="w-full" style="min-height: 500px;"></div>
    </div>

    <div class="bg-white rounded-xl shadow-lg p-4 border border-gray-100">
        <div class="flex flex-wrap gap-4 text-sm">
            <div class="flex items-center">
                <span class="inline-block w-4 h-4 rounded-full bg-blue-500 mr-2"></span>
                <span class="text-gray-700">Leaf Switch</span>
            </div>
            <div class="flex items-center">
                <span class="inline-block w-4 h-4 rounded-full bg-green-500 mr-2"></span>
                <span class="text-gray-700">FEX Device</span>
            </div>
            <div class="flex items-center">
                <span class="inline-block w-4 h-1 bg-gray-400 mr-2"></span>
                <span class="text-gray-700">Connection</span>
            </div>
            <div class="flex items-center">
                <span class="inline-block w-4 h-4 rounded-full bg-red-500 mr-2"></span>
                <span class="text-gray-700">Overloaded (>12 FEX)</span>
            </div>
        </div>
    </div>
</div>

<!-- Leaf-FEX Mapping Dashboard -->
<div id="mapping-dashboard" class="dashboard-panel">
    <!-- Controls -->
    <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100 mb-8">
        <div class="flex flex-wrap gap-4 items-center">
            <div class="flex-1 min-w-[250px]">
                <input type="text" id="mapping-search" placeholder="Search leaf or FEX..." onkeyup="filterMappingTable()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
            </div>
            <label class="flex items-center text-sm text-gray-700">
                <input type="checkbox" id="show-overloaded-only" onchange="filterMappingTable()" class="mr-2 rounded text-primary-600 focus:ring-primary-500">
                Show Overloaded Only (>12 FEX)
            </label>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
            <h3 class="text-3xl font-bold text-gray-900 mb-1">{{ viz_data.get('leaf_fex_mapping', {}).get('statistics', {}).get('total_leafs', 0) }}</h3>
            <p class="text-sm text-gray-600">Total Leafs</p>
        </div>
        <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
            <h3 class="text-3xl font-bold text-gray-900 mb-1">{{ viz_data.get('leaf_fex_mapping', {}).get('statistics', {}).get('total_fex', 0) }}</h3>
            <p class="text-sm text-gray-600">Total FEX</p>
        </div>
        <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
            <h3 class="text-3xl font-bold text-gray-900 mb-1">{{ viz_data.get('leaf_fex_mapping', {}).get('statistics', {}).get('avg_fex_per_leaf', 0) }}</h3>
            <p class="text-sm text-gray-600">Avg FEX per Leaf</p>
        </div>
        <div class="bg-white rounded-xl shadow-lg p-6 border border-yellow-200 bg-yellow-50">
            <h3 class="text-3xl font-bold text-yellow-800 mb-1">{{ viz_data.get('leaf_fex_mapping', {}).get('statistics', {}).get('overloaded_leafs', 0) }}</h3>
            <p class="text-sm text-yellow-700">Overloaded Leafs</p>
        </div>
    </div>

    <!-- Mapping Table -->
    <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200" id="mapping-table">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Leaf ID</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Leaf Name</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Model</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">FEX Count</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">FEX Devices</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for mapping in viz_data.get('leaf_fex_mapping', {}).get('mappings', []) %}
                    <tr class="mapping-row hover:bg-gray-50 {% if mapping.overloaded %}bg-yellow-50{% endif %}"
                        data-leaf-id="{{ mapping.leaf_id }}"
                        data-fex-count="{{ mapping.fex_count }}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">{{ mapping.leaf_id }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{{ mapping.leaf_name }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <span class="px-2 py-1 inline-flex text-xs leading-5 font-medium rounded-full bg-blue-100 text-blue-800">
                                {{ mapping.leaf_model }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <span class="{% if mapping.overloaded %}text-yellow-800 font-semibold{% else %}text-gray-700{% endif %}">
                                {{ mapping.fex_count }}
                                {% if mapping.overloaded %}<span class="ml-1">‚ö†Ô∏è</span>{% endif %}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm">
                            <div class="flex flex-wrap gap-1">
                                {% for fex in mapping.attached_fex %}
                                <span class="px-2 py-1 inline-flex text-xs leading-5 font-medium rounded-full bg-green-100 text-green-800" title="{{ fex.model }} - {{ fex.status }}">
                                    FEX-{{ fex.fex_id }}
                                </span>
                                {% endfor %}
                                {% if mapping.fex_count == 0 %}
                                <span class="text-gray-400 italic">No FEX attached</span>
                                {% endif %}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            {% if mapping.overloaded %}
                            <span class="px-3 py-1 inline-flex text-xs leading-5 font-medium rounded-full bg-yellow-100 text-yellow-800">Overloaded</span>
                            {% elif mapping.fex_count == 0 %}
                            <span class="px-3 py-1 inline-flex text-xs leading-5 font-medium rounded-full bg-gray-100 text-gray-800">No FEX</span>
                            {% else %}
                            <span class="px-3 py-1 inline-flex text-xs leading-5 font-medium rounded-full bg-green-100 text-green-800">Normal</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <button onclick="viewLeafTopology('{{ mapping.leaf_id }}')" class="text-primary-600 hover:text-primary-800 font-medium">
                                View Topology
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Device Hierarchy Dashboard -->
<div id="hierarchy-dashboard" class="dashboard-panel">
    <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100 mb-8">
        <h2 class="text-2xl font-bold text-gray-900 mb-2">Complete Device-EPG-VLAN Hierarchy</h2>
        <p class="text-gray-600">Comprehensive view of Leaf ‚Üí FEX ‚Üí EPG ‚Üí VLAN deployment</p>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100 mb-8">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
            <div>
                <label for="hierarchy-leaf-filter" class="block text-sm font-medium text-gray-700 mb-1">Filter by Leaf:</label>
                <select id="hierarchy-leaf-filter" onchange="filterHierarchy()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                    <option value="all">All Leafs</option>
                    {% for leaf_data in viz_data.get('device_mapping', {}).get('hierarchy', []) %}
                    <option value="{{ leaf_data.leaf_id }}">Leaf-{{ leaf_data.leaf_id }} ({{ leaf_data.leaf_name }})</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="hierarchy-tenant-filter" class="block text-sm font-medium text-gray-700 mb-1">Filter by Tenant:</label>
                <select id="hierarchy-tenant-filter" onchange="filterHierarchy()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                    <option value="all">All Tenants</option>
                </select>
            </div>
            <div>
                <label for="hierarchy-vlan-filter" class="block text-sm font-medium text-gray-700 mb-1">Filter by VLAN:</label>
                <input type="text" id="hierarchy-vlan-filter" placeholder="e.g., 100 or 100-200" onkeyup="filterHierarchy()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
            </div>
            <div>
                <label for="hierarchy-search" class="block text-sm font-medium text-gray-700 mb-1">Search:</label>
                <input type="text" id="hierarchy-search" placeholder="Search EPG, leaf, or FEX..." onkeyup="filterHierarchy()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
            </div>
        </div>
        <div class="flex flex-wrap gap-4 items-center">
            <label class="flex items-center text-sm text-gray-700">
                <input type="checkbox" id="show-empty-devices" onchange="filterHierarchy()" class="mr-2 rounded text-primary-600 focus:ring-primary-500">
                Show devices with no EPGs
            </label>
            <label class="flex items-center text-sm text-gray-700">
                <input type="checkbox" id="expand-all" onchange="toggleExpandAll()" class="mr-2 rounded text-primary-600 focus:ring-primary-500">
                Expand all
            </label>
            <button onclick="exportHierarchyData()" class="px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-lg text-sm font-medium transition-colors">
                üì• Export CSV
            </button>
        </div>
    </div>

    <!-- Summary Statistics -->
    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-8">
        <div class="bg-white rounded-xl shadow-lg p-4 border border-gray-100">
            <h3 class="text-2xl font-bold text-gray-900 mb-1">{{ viz_data.get('device_mapping', {}).get('statistics', {}).get('total_devices', 0) }}</h3>
            <p class="text-xs text-gray-600">Total Devices</p>
        </div>
        <div class="bg-white rounded-xl shadow-lg p-4 border border-gray-100">
            <h3 class="text-2xl font-bold text-gray-900 mb-1">{{ viz_data.get('device_mapping', {}).get('statistics', {}).get('total_epgs_mapped', 0) }}</h3>
            <p class="text-xs text-gray-600">EPGs Deployed</p>
        </div>
        <div class="bg-white rounded-xl shadow-lg p-4 border border-gray-100">
            <h3 class="text-2xl font-bold text-gray-900 mb-1">{{ viz_data.get('device_mapping', {}).get('statistics', {}).get('total_vlans_used', 0) }}</h3>
            <p class="text-xs text-gray-600">VLANs Used</p>
        </div>
        <div class="bg-white rounded-xl shadow-lg p-4 border border-yellow-200 bg-yellow-50">
            <h3 class="text-2xl font-bold text-yellow-800 mb-1">{{ viz_data.get('device_mapping', {}).get('statistics', {}).get('devices_with_multiple_tenants', 0) }}</h3>
            <p class="text-xs text-yellow-700">Multi-Tenant</p>
        </div>
        <div class="bg-white rounded-xl shadow-lg p-4 border border-blue-200 bg-blue-50">
            <h3 class="text-2xl font-bold text-blue-800 mb-1">{{ viz_data.get('device_mapping', {}).get('statistics', {}).get('vlans_spanning_devices', 0) }}</h3>
            <p class="text-xs text-blue-700">VLANs Spanning</p>
        </div>
        <div class="bg-white rounded-xl shadow-lg p-4 border border-blue-200 bg-blue-50">
            <h3 class="text-2xl font-bold text-blue-800 mb-1">{{ viz_data.get('device_mapping', {}).get('statistics', {}).get('epgs_spanning_devices', 0) }}</h3>
            <p class="text-xs text-blue-700">EPGs Spanning</p>
        </div>
    </div>

    <!-- Hierarchical Tree View -->
    <div class="space-y-4">
        {% for leaf_data in viz_data.get('device_mapping', {}).get('hierarchy', []) %}
        <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden hierarchy-node" data-leaf-id="{{ leaf_data.leaf_id }}">
            <div class="px-6 py-4 bg-gradient-to-r from-blue-50 to-white border-b border-gray-200 cursor-pointer hover:bg-blue-50 transition-colors" onclick="toggleNode(this)">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <span class="toggle-icon text-gray-400 transition-transform">‚ñ∂</span>
                        <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                        </svg>
                        <div>
                            <span class="text-lg font-semibold text-gray-900">Leaf-{{ leaf_data.leaf_id }}</span>
                            <span class="text-gray-600 ml-2">({{ leaf_data.leaf_name }})</span>
                        </div>
                        <span class="px-2 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800">{{ leaf_data.leaf_model }}</span>
                    </div>
                    <div class="flex items-center space-x-4 text-sm text-gray-600">
                        <span>{{ leaf_data.total_fex }} FEX</span>
                        <span>{{ leaf_data.total_epgs }} EPGs</span>
                    </div>
                </div>
            </div>
            <div class="node-content px-6 py-4" style="display: none;">
                {% if leaf_data.direct_epgs %}
                <div class="mb-6">
                    <h4 class="text-sm font-semibold text-gray-700 mb-3">EPGs directly on Leaf-{{ leaf_data.leaf_id }}:</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                        {% for epg in leaf_data.direct_epgs %}
                        <div class="flex items-center space-x-2 px-3 py-2 bg-gray-50 rounded-lg" data-tenant="{{ epg.tenant }}" data-vlan="{{ epg.vlan }}">
                            <svg class="h-4 w-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                            </svg>
                            <span class="text-sm font-medium text-gray-900">{{ epg.epg }}</span>
                            <span class="px-2 py-0.5 text-xs rounded-full bg-purple-100 text-purple-800">{{ epg.tenant }}</span>
                            <span class="px-2 py-0.5 text-xs rounded-full bg-green-100 text-green-800">VLAN {{ epg.vlan if epg.vlan else 'N/A' }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {% for fex in leaf_data.fex_devices %}
                <div class="mb-4 border border-gray-200 rounded-lg overflow-hidden">
                    <div class="px-4 py-3 bg-gradient-to-r from-green-50 to-white border-b border-gray-200 cursor-pointer hover:bg-green-50 transition-colors" onclick="toggleNode(this)">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <span class="toggle-icon text-gray-400 text-sm transition-transform">‚ñ∂</span>
                                <svg class="h-5 w-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                </svg>
                                <span class="font-semibold text-gray-900">FEX-{{ fex.fex_id }}</span>
                                <span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800">{{ fex.fex_model }}</span>
                                <span class="px-2 py-1 text-xs font-medium rounded-full {% if fex.status == 'active' %}bg-green-100 text-green-800{% else %}bg-gray-100 text-gray-800{% endif %}">
                                    {{ fex.status }}
                                </span>
                            </div>
                            <div class="flex items-center space-x-4 text-sm text-gray-600">
                                <span>{{ fex.epg_count }} EPGs</span>
                                <span>{{ fex.vlan_count }} VLANs</span>
                                <span>{{ fex.tenant_count }} Tenants</span>
                            </div>
                        </div>
                    </div>
                    <div class="node-content px-4 py-3 bg-gray-50" style="display: none;">
                        {% if fex.epgs %}
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                            {% for epg in fex.epgs %}
                            <div class="flex items-center space-x-2 px-3 py-2 bg-white rounded-lg shadow-sm" data-tenant="{{ epg.tenant }}" data-vlan="{{ epg.vlan }}">
                                <svg class="h-4 w-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                                </svg>
                                <span class="text-sm font-medium text-gray-900">{{ epg.epg }}</span>
                                <span class="px-2 py-0.5 text-xs rounded-full bg-purple-100 text-purple-800">{{ epg.tenant }}</span>
                                <span class="px-2 py-0.5 text-xs rounded-full bg-green-100 text-green-800">VLAN {{ epg.vlan if epg.vlan else 'N/A' }}</span>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <p class="text-sm text-gray-500 italic">No EPGs deployed on this FEX</p>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}

                {% if not leaf_data.fex_devices and not leaf_data.direct_epgs %}
                <p class="text-sm text-gray-500 italic">No FEX or EPGs on this leaf</p>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Quick Stats Table -->
    <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden mt-8">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900">Quick Statistics by Device</h3>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Device ID</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Device Type</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">EPG Count</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">VLAN Count</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tenant Count</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">VLANs Used</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for device_id, device_data in viz_data.get('device_mapping', {}).get('device_map', {}).items() %}
                    <tr class="hover:bg-gray-50" data-device-type="{{ device_data.device_type }}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">{{ device_id }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <span class="px-2 py-1 inline-flex text-xs leading-5 font-medium rounded-full {% if device_data.device_type == 'leaf' %}bg-blue-100 text-blue-800{% else %}bg-green-100 text-green-800{% endif %}">
                                {{ device_data.device_type }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{{ device_data.epg_count }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{{ device_data.vlan_count }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <span class="{% if device_data.tenant_count > 1 %}text-yellow-800 font-semibold{% else %}text-gray-700{% endif %}">
                                {{ device_data.tenant_count }}
                                {% if device_data.tenant_count > 1 %}<span class="ml-1" title="Multi-tenant device">‚ö†Ô∏è</span>{% endif %}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                            {% if device_data.vlans %}
                                {{ device_data.vlans[0] }}{% if device_data.vlans|length > 1 %}-{{ device_data.vlans[-1] }}{% endif %}
                            {% else %}
                                N/A
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <button onclick="scrollToDevice('{{ device_id }}')" class="text-primary-600 hover:text-primary-800 font-medium">
                                üîç View
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Port Utilization Dashboard -->
<div id="utilization-dashboard" class="dashboard-panel">
    <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100 mb-8">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">FEX Port Utilization</h3>
        <div class="relative" style="height: 400px;">
            <canvas id="portUtilizationChart"></canvas>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Consolidation Scores</h3>
            <div class="relative" style="height: 300px;">
                <canvas id="consolidationScoreChart"></canvas>
            </div>
        </div>
        <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Top Consolidation Candidates</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">FEX ID</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Utilization</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Score</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Recommendation</th>
                        </tr>
                    </thead>
                    <tbody id="consolidation-table" class="bg-white divide-y divide-gray-200">
                        <!-- Populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- VLAN Dashboard -->
<div id="vlans-dashboard" class="dashboard-panel">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">VLAN Usage Distribution</h3>
            <div class="relative" style="height: 300px;">
                <canvas id="vlanDistributionChart"></canvas>
            </div>
        </div>
        <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">VLAN Overlaps</h3>
            <div id="vlan-overlaps" class="space-y-2">
                <!-- Populated by JavaScript -->
            </div>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">VLAN Range Heatmap</h3>
        <div id="vlan-heatmap"></div>
    </div>
</div>

<!-- EPG Complexity Dashboard -->
<div id="complexity-dashboard" class="dashboard-panel">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">EPG Complexity Distribution</h3>
            <div class="relative" style="height: 300px;">
                <canvas id="complexityDistributionChart"></canvas>
            </div>
        </div>
        <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Complexity Factors</h3>
            <div class="relative" style="height: 300px;">
                <canvas id="complexityFactorsChart"></canvas>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Top 20 Most Complex EPGs</h3>
        <div class="relative" style="height: 400px;">
            <canvas id="topComplexEpgsChart"></canvas>
        </div>
    </div>
</div>

<!-- Migration Readiness Dashboard -->
<div id="migration-dashboard" class="dashboard-panel">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-white rounded-xl shadow-lg p-6 border border-green-200 bg-green-50">
            <h3 class="text-lg font-semibold text-green-800 mb-2">‚úì Ready</h3>
            <p class="text-4xl font-bold text-green-900" id="ready-count">0</p>
            <p class="text-sm text-green-700">Items</p>
        </div>
        <div class="bg-white rounded-xl shadow-lg p-6 border border-yellow-200 bg-yellow-50">
            <h3 class="text-lg font-semibold text-yellow-800 mb-2">‚ö† Warnings</h3>
            <p class="text-4xl font-bold text-yellow-900" id="warning-count">0</p>
            <p class="text-sm text-yellow-700">Items</p>
        </div>
        <div class="bg-white rounded-xl shadow-lg p-6 border border-red-200 bg-red-50">
            <h3 class="text-lg font-semibold text-red-800 mb-2">‚úó Issues</h3>
            <p class="text-4xl font-bold text-red-900" id="issue-count">0</p>
            <p class="text-sm text-red-700">Items</p>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Migration Flags by Category</h3>
            <div class="relative" style="height: 300px;">
                <canvas id="migrationFlagsChart"></canvas>
            </div>
        </div>
        <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">VPC Symmetry Analysis</h3>
            <div class="relative" style="height: 300px;">
                <canvas id="vpcSymmetryChart"></canvas>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Detailed Findings</h3>
        <div id="migration-flags-list" class="space-y-3">
            <!-- Populated by JavaScript -->
        </div>
    </div>
</div>

{% endif %}

<!-- Embedded Data for JavaScript -->
<script id="viz-data" type="application/json">
    {{ viz_data | tojson | safe }}
</script>

<style>
/* Tab active state */
.dashboard-tab.active {
    color: #3b82f6;
    border-bottom-color: #3b82f6;
    background-color: #eff6ff;
}

/* Panel visibility */
.dashboard-panel {
    display: none;
}
.dashboard-panel.active {
    display: block;
}

/* Toggle icons */
.toggle-icon {
    display: inline-block;
    transition: transform 0.2s;
}
.node-content.expanded + .toggle-icon,
.toggle-icon.expanded {
    transform: rotate(90deg);
}

/* Chart containers need maintainAspectRatio: false */
canvas {
    max-height: 100%;
}
</style>

{% endblock %}

{% block scripts %}
<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<!-- D3.js for Topology Visualization -->
<script src="https://d3js.org/d3.v7.min.js"></script>

<script src="{{ url_for('static', filename='dashboards.js') }}"></script>

<script>
// Enhanced toggle function for hierarchy nodes
function toggleNode(header) {
    const content = header.nextElementSibling;
    const icon = header.querySelector('.toggle-icon');

    if (content.style.display === 'none' || content.style.display === '') {
        content.style.display = 'block';
        if (icon) icon.style.transform = 'rotate(90deg)';
    } else {
        content.style.display = 'none';
        if (icon) icon.style.transform = 'rotate(0deg)';
    }
}

// View leaf topology
function viewLeafTopology(leafId) {
    // Switch to topology tab
    switchTab('topology');
    // Set the filter
    const filter = document.getElementById('leaf-filter');
    if (filter) {
        filter.value = leafId;
        filterTopology();
    }
}

// Scroll to device in hierarchy
function scrollToDevice(deviceId) {
    // Switch to hierarchy tab
    switchTab('hierarchy');
    // Find and scroll to the device
    setTimeout(() => {
        const deviceNode = document.querySelector(`[data-leaf-id="${deviceId}"], [data-fex-id="${deviceId}"]`);
        if (deviceNode) {
            deviceNode.scrollIntoView({ behavior: 'smooth', block: 'center' });
            deviceNode.classList.add('ring-2', 'ring-primary-500');
            setTimeout(() => {
                deviceNode.classList.remove('ring-2', 'ring-primary-500');
            }, 2000);
        }
    }, 100);
}
</script>
{% endblock %}
